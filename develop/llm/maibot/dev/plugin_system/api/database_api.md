---\nlast_updated: 2026-01-19\n---\n\n## 概述\n`database_api.py` 模块为 MaiBot 插件系统提供统一的数据库访问层。该模块封装了 Peewee ORM 操作，允许插件开发者通过异步函数执行记录的查询、创建、更新、删除及计数操作，而无需直接编写复杂的 SQL 语句。\n\n## API 列表\n\n### 1. db_query\n通用的数据库操作接口。\n- **函数签名**: `async def db_query(model_class: Type[Model], data: Optional[Dict[str, Any]] = None, query_type: Optional[str] = "get", filters: Optional[Dict[str, Any]] = None, limit: Optional[int] = None, order_by: Optional[List[str]] = None, single_result: Optional[bool] = False)`\n- **支持类型**: `"get"`, `"create"`, `"update"`, `"delete"`, `"count"`。\n- **排序规则**: `order_by` 列表中的字符串若以 `-` 开头则表示降序。\n\n### 2. db_save\n实现数据的 Upsert（更新或创建）逻辑。\n- **函数签名**: `async def db_save(model_class: Type[Model], data: Dict[str, Any], key_field: Optional[str] = None, key_value: Optional[Any] = None)`\n- **行为**: 若指定 `key_field` 且数据库中存在匹配 `key_value` 的记录，则执行更新；否则执行创建。\n\n### 3. db_get\n`db_query` 的简化封装，专注于数据检索。\n- **函数签名**: `async def db_get(model_class: Type[Model], filters: Optional[Dict[str, Any]] = None, limit: Optional[int] = None, order_by: Optional[str] = None, single_result: Optional[bool] = False)`\n\n### 4. store_action_info\n专门用于记录插件执行动作（Action）信息的辅助函数。\n- **功能**: 自动构建 `ActionRecords` 记录，包含 `action_id`、`time`、`action_name`、`action_data` 等字段，并关联 `chat_stream` 信息。\n\n## 调用约定\n1. **异步要求**: 所有数据库 API 均为异步函数，必须使用 `await` 关键字调用。\n2. **模型依赖**: 调用者需提供继承自 `peewee.Model` 的模型类。\n3. **错误处理**: 模块内部捕获了 `DoesNotExist` 及其他通用异常。查询失败时，若 `single_result` 为 `True` 则返回 `None`，否则返回空列表 `[]`。\n\n## 变更影响分析\n- **接口稳定性**: 该 API 封装了底层 ORM 细节，底层数据库迁移或更换 Peewee 版本时，只要保持函数签名一致，插件代码无需修改。\n- **性能注意**: `db_query` 支持 `limit` 参数，在处理大量数据（如消息历史）时应始终设置合理的限制。\n\n## 证据\n- 源码位置 `src/plugin_system/apis/database_api.py` 定义了 `async def db_query` 函数，其中包含对 `query_type` 的校验：`if query_type not in ["get", "create", "update", "delete", "count"]: raise ValueError(...)`。\n- 源码位置 `src/plugin_system/apis/database_api.py` 定义了 `async def db_save` 函数，通过 `if key_field and key_value is not None:` 判断是否执行更新逻辑。