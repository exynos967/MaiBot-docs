name: Auto Sync LLM Docs (maim_message master)

on:
  schedule:
    # GitHub Actions cron uses UTC.
    - cron: "10 */3 * * *"
  workflow_dispatch:
    inputs:
      force_latest:
        description: "Force sync with the latest commit"
        required: false
        default: false
        type: boolean
      bootstrap:
        description: "Generate initial docs baseline from repo snapshot"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-sync-llm-docs-maim-message-master
  cancel-in-progress: false

jobs:
  auto-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Restore sync state cache
        uses: actions/cache/restore@v4
        with:
          path: scripts/state_maim_message_master.json
          key: sync-state-maim-message-master-${{ github.run_id }}
          restore-keys: |
            sync-state-maim-message-master-

      - name: Run sync script
        id: sync_script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_REPO: Mai-with-u/maim_message
          UPSTREAM_BRANCH: master
          STATE_FILE: scripts/state_maim_message_master.json
          DOCS_ROOT: develop/llm/maim_message/master
          ENABLE_SNAPSHOTS: "1"

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BASE_URL: ${{ secrets.BASE_URL }}
          MODEL_NAME: ${{ secrets.MODEL_NAME }}
          GEMINI_API_VERSION: ${{ vars.GEMINI_API_VERSION || 'v1beta' }}
          LLM_API_STYLE: ${{ vars.LLM_API_STYLE || 'auto' }}
          SYNC_LOOKBACK_HOURS: ${{ vars.SYNC_LOOKBACK_HOURS || '6' }}
          LLM_MAX_CONTEXT_CHARS: ${{ secrets.LLM_MAX_CONTEXT_CHARS }}
        run: |
          args=""
          if [ "${{ inputs.bootstrap }}" = "true" ]; then
            args="$args --bootstrap"
          fi
          if [ "${{ inputs.force_latest }}" = "true" ]; then
            args="$args --force-latest"
          fi
          python scripts/main.py $args

      - name: Save sync state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: scripts/state_maim_message_master.json
          key: sync-state-maim-message-master-${{ github.run_id }}

      - name: Set branch name
        if: steps.sync_script.outputs.has_updates == 'true'
        id: vars
        run: echo "branch=auto-llm-docs-maim-message-master-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.sync_script.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.vars.outputs.branch }}
          title: ${{ steps.sync_script.outputs.pr_title }}
          body: ${{ steps.sync_script.outputs.pr_body }}
          labels: auto-generated
          commit-message: "docs(llm/maim_message/master): automated sync from upstream"
          base: ${{ github.ref_name }}
          add-paths: |
            develop/llm/maim_message/master/**
